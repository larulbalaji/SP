<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" name="Update view attributes" type="SERI">
  <Variable name="attrModel" type="java.util.Map"/>
  <Variable initializer="string:true" name="transient"/>
  <Step icon="Start" name="Start" posX="34" posY="26">
    <Transition to="Build Attribute Set"/>
  </Step>
  <Step icon="Default" name="Build Attribute Set" posX="298" posY="89" resultVariable="attrForm">
    <Script>
      <Source><![CDATA[
import sailpoint.object.Attributes;
import sailpoint.object.Field;
import sailpoint.object.Form;
import sailpoint.object.Form.Button;
import sailpoint.object.Form.Section;

import sailpoint.object.ObjectAttribute;
import sailpoint.object.ObjectConfig;
import sailpoint.object.UIConfig;
import sailpoint.tools.Internationalizer;

/****************************************************
   Build a form to represent all the UI attributes.
   Also build a model (HashMap) of all the UI attributes and whether they are currently
   enabled or not. Since we can only pass one resultVariable back (in this case, we are
   returning the generated form), we have to manually set the other return value (the
   attrModel map) with 'workflow.put(key, value)'
****************************************************/

Form frm=new Form();
frm.put("pageTitle", "Select view attributes");

attrModel=new HashMap();

List buttons=new ArrayList();
buttons.add(new Button("Next", "next"));


buttons.add(new Button("Cancel", "cancel"));
frm.setButtons(buttons);

Section sect=new Section();


UIConfig uiConfig=context.getObjectByName(UIConfig.class, "UIConfig");
String sviewAttrs=uiConfig.get("identityViewAttributes");
String[] viewAttrs=new String[0];
if(sviewAttrs!=null) {
  viewAttrs=sviewAttrs.split(",");
}

ObjectConfig idConfig=context.getObjectByName(ObjectConfig.class, "Identity");
List l=idConfig.getObjectAttributes();

/*
    Put all the Identity attributes on the form and in the model.
    Set the variable to 'true' in the model if it is currently in the
    'identityViewAttributes' list in the UIConfig object.
*/

for ( ObjectAttribute attr: l ) {
  if(!attr.isSilent()) {
    Field f=new Field();
    f.setType("boolean");
    f.setName(attr.getName());
    f.setDisplayName(attr.getDisplayName());
    f.setValue(Boolean.FALSE);
    attrModel.put(attr.getName(), Boolean.FALSE);
    for(int i=0;i<viewAttrs.length;i++) {
      if(viewAttrs[i].equals(attr.getName())) {
        f.setValue(Boolean.TRUE);
        attrModel.put(attr.getName(), Boolean.TRUE);
      }
    }
    sect.add(f);
  }

}

workflow.put("attrModel", attrModel);
frm.add(sect);
return frm;]]></Source>
    </Script>
    <Transition to="Print AttrModel"/>
  </Step>
  <Step icon="Default" name="Print AttrModel" posX="528" posY="192">
    <Script>
      <Source><![CDATA[
import sailpoint.object.ApprovalSet;
import sailpoint.object.ApprovalItem;
import sailpoint.object.Attributes;
import sailpoint.object.ObjectAttribute;
import sailpoint.object.ObjectConfig;
import sailpoint.object.UIConfig;

serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.UpdateViewAttributes.PrintModel");
for(String item: attrModel.keySet()) {
  Object value=attrModel.get(item);
  serilog.trace(item+"="+value);
}
      ]]></Source>
    </Script>
    <Transition to="Select Attributes"/>
  </Step>
  <Step icon="Approval" name="Select Attributes" posX="373" posY="186">
    <Approval name="Select Attributes" owner="string:spadmin" return="attrModel">
      <Arg name="workItemRequester" value="string:$(launcher)"/>
      <Arg name="workItemType" value="string:Form"/>
      <Arg name="workItemDescription" value="string:Select display attributes"/>
      <Arg name="workItemForm" value="ref:attrForm"/>
      <Arg name="workItemFormBasePath" value="string:attrModel"/>
    </Approval>
    <Description>Display the UI attributes to the user to see which attributes
to display on the Identity cube's 'attributes' tab </Description>
    <Transition to="Set Attributes"/>
  </Step>
  <Step icon="Default" name="Set Attributes" posX="528" posY="192">
    <Script>
      <Source><![CDATA[
import sailpoint.object.ApprovalSet;
import sailpoint.object.ApprovalItem;
import sailpoint.object.Attributes;
import sailpoint.object.ObjectAttribute;
import sailpoint.object.ObjectConfig;
import sailpoint.object.UIConfig;

/*
    Update the UIConfig object's 'identityViewAttributes' list with the
    newly selected attributes
*/

serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.UpdateViewAttributes.SetAttributes");

UIConfig uiConfig=context.getObjectByName(UIConfig.class, "UIConfig");

String attrList="";
boolean first=true;
for(String item: attrModel.keySet()) {
  Object value=attrModel.get(item);
  serilog.debug(item+"="+value);
  if( Boolean.TRUE.equals(value) ) {
  if (first) {
    first=false;
  } else {
    attrList+=",";
  }
  attrList+=(item);
}
}

serilog.trace("attrList="+attrList);

uiConfig=context.getObjectByName(UIConfig.class, "UIConfig");
uiConfig.setIdentityViewAttributes(attrList);
context.saveObject(uiConfig);
context.commitTransaction();

      ]]></Source>
    </Script>
    <Transition to="Stop"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="648" posY="267"/>
</Workflow>
