<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow  explicitTransitions="true" name="QuickLink - Reactivate User" type="">
  <Variable initializer="string:true" name="transient">
    <Description>Set to false to cause workflow-related objects, such as approval
    work items, to be saved in the database even if they are only
    viewed by the person registering.</Description>
  </Variable>
  <Variable initializer="string:ReactivateUser" name="flow">
    <Description>The name of the LCM flow that launched this workflow.</Description>
  </Variable>
  <Variable initializer="string:false" name="trace">
    <Description>Used for debugging this workflow and when set to true trace
      will be sent to stdout.</Description>
  </Variable>
  <Variable initializer="script:return new ArrayList();" input="true" name="identityNames" type="java.util.List">
    <Description>The names of the identities we're reactivating.</Description>
  </Variable>
  <Variable input="true" name="requester"/>
  <Variable initializer="script:return 0;" name="incrementor" type="int"/>
  <Variable name="reactivationDate"/>
  <Step icon="Start" name="Start" posX="9" posY="25">
    <Transition to="Create User List"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="753" posY="27"/>
  <Step icon="Default" name="Confirm Selected Users" posX="227" posY="25">
    <Approval name="Confirm Selected Users" owner="ref:requester" return="reactivationDate" send="identityNames">
      <Arg name="workItemType" value="string:Form"/>
      <Arg name="workItemDescription" value="string:Confirm Reactivated Account(s) Form"/>
      <Arg name="workItemForm" value="string:Reactivate User Confirmation"/>
    </Approval>
    <Transition to="Set Values"/>
  </Step>
  <Step icon="Default" name="Create User List" posX="109" posY="25">
    <Script>
      <Source><![CDATA[
import sailpoint.object.Identity;

// Expect: java.util.List quickLinkIdentityIds
serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.ReactivateUser.CreateUserList");
serilog.debug("----");

for(String id: quickLinkIdentityIds) {
  Identity aUser = context.getObjectById(Identity.class, id);
  serilog.debug("A USER:  "+ aUser);
  serilog.debug("A USER IS:  "+ aUser.getName());
  identityNames.add(aUser.getName());
}
      ]]></Source>
    </Script>
    <Transition to="Confirm Selected Users"/>
  </Step>
  <Step action="call:scheduleWorkflowEvent" icon="Task" name="Schedule Reactivate" posX="486" posY="176">
    <Arg name="workflow">
      <Script>
        <Source><![CDATA[
import sailpoint.object.Configuration;

serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.ReactivateUser.ScheduleReactivate.arg.workflow");

String wfName=null;

Configuration conf=context.getObjectByName(Configuration.class, "Deprovisioning Configuration");
if(conf!=null){
  wfName=conf.get("ReactivationUpdateWorkflow");
} else {
  log.error("Cannot find configuration object 'Deprovisioning Configuration'");
}
serilog.debug("Scheduling Reactivate with workflow '"+wfName+"'");
return wfName;
        ]]></Source>
      </Script>
    </Arg>
    <Arg name="owner" value="ref:identityName"/>
    <Arg name="eventName" value="string:Reactivate User"/>
    <Arg name="scheduleDate">
      <Script>
        <Source><![CDATA[
import sailpoint.object.Configuration;

serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.ReactivateUser.ScheduleReactivate.arg.scheduleDate");

serilog.debug("reactivationDate='"+reactivationDate+"'");
return reactivationDate;
        ]]></Source>
      </Script>
    </Arg>
    <!-- value="ref:reactivationDate"/-->
    <Arg name="identityName" value="ref:identityName"/>
    <!-- workaround for Bug #27980 -->
    <Arg name="catchExceptions" value="true"/>
    <Transition to="Stop" when="script:identityNames.size()>= incrementor;"/>
    <Transition to="Set Values"/>
  </Step>
  <Step icon="Default" name="Set Values" posX="291" posY="284" resultVariable="identityName">
    <Script>
      <Source><![CDATA[
serilog=org.apache.commons.logging.LogFactory.getLog("SERI.Workflow.ReactivateUser.SetValues");
serilog.debug("----");
String identityName =(String)identityNames.get(incrementor);
incrementor = incrementor +1;

serilog.debug("incrementor:  " + incrementor);
serilog.debug("identityName:  "+ identityName);
return identityName;
]]></Source>
    </Script>
    <Transition to="Schedule Reactivate"/>
  </Step>
</Workflow>
